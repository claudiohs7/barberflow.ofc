"use strict";(()=>{var e={};e.id=8350,e.ids=[8350],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47400:(e,o,t)=>{t.r(o),t.d(o,{originalPathname:()=>h,patchFetch:()=>w,requestAsyncStorage:()=>k,routeModule:()=>b,serverHooks:()=>g,staticGenerationAsyncStorage:()=>x});var r={};t.r(r),t.d(r,{POST:()=>m});var s=t(49303),a=t(88716),n=t(60670),c=t(87070),i=t(73824),u=t(42046),d=t(58181);let p={prod_basico_id_na_cackto:"B\xe1sico",prod_premium_id_na_cackto:"Premium",633283:"B\xe1sico",r33rggt:"Premium"},l={BÃ¡sico:49.9/30,Premium:119.9/30};async function m(e){let o=process.env.CACKTO_WEBHOOK_SECRET,t=e.headers.get("x-cackto-secret");if(!o||!t||t!==o)return console.warn("AVISO: Tentativa de webhook n\xe3o autorizada."),c.NextResponse.json({success:!1,message:"N\xe3o autorizado."},{status:401});try{let o=await e.json();if(console.log("Cackto webhook recebido:",JSON.stringify(o)),"subscription.created"===o.event||"charge.paid"===o.event){let e;let t=o.data.customer_id,r=p[o.data.product_id||""]||"Premium";if(!t)return c.NextResponse.json({success:!1,message:"customer_id n\xe3o encontrado no payload do webhook."},{status:400});if("test_customer_id"===o.data.customer_id)return console.log("Evento de teste recebido com sucesso."),c.NextResponse.json({success:!0,message:"Evento de teste recebido."});let s=await (0,d.vX)(t);if(!s)return console.error(`Webhook error: Barbearia com ID ${t} n\xe3o encontrada.`),c.NextResponse.json({success:!1,message:`Barbearia com ID ${t} n\xe3o encontrada.`},{status:404});let a=s.plan||"B\xe1sico",n=s.expiryDate?new Date(s.expiryDate):null,m=new Date;if(r===a){let o=n&&n>m?n:m;e=(0,i.E)(o,365)}else{let o=0;n&&n>m&&(o=(0,u.j)(n,m)*(l[a]||0));let t=365*l[r],s=(o+t)/l[r];e=(0,i.E)(m,Math.floor(s))}await (0,d.Ye)(t,{plan:r,status:"Ativa",expiryDate:e}),console.log(`Plano ${r} ativado para a barbearia: ${t}. V\xe1lido at\xe9: ${e.toLocaleDateString()}`)}return c.NextResponse.json({success:!0,message:"Webhook recebido com sucesso."})}catch(e){return console.error("Erro ao processar o webhook da Cackto:",e),c.NextResponse.json({success:!1,message:"Erro interno no servidor.",error:e.message},{status:500})}}let b=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/webhooks/cackto/route",pathname:"/api/webhooks/cackto",filename:"route",bundlePath:"app/api/webhooks/cackto/route"},resolvedPagePath:"/var/www/barberflow/src/app/api/webhooks/cackto/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:k,staticGenerationAsyncStorage:x,serverHooks:g}=b,h="/api/webhooks/cackto/route";function w(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:x})}}};var o=require("../../../../webpack-runtime.js");o.C(e);var t=e=>o(o.s=e),r=o.X(0,[8948,5972,86,2533],()=>t(47400));module.exports=r})();