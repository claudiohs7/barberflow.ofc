"use strict";(()=>{var e={};e.id=9586,e.ids=[9586],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},71568:e=>{e.exports=require("zlib")},47463:(e,r,o)=>{o.r(r),o.d(r,{originalPathname:()=>w,patchFetch:()=>b,requestAsyncStorage:()=>x,routeModule:()=>h,serverHooks:()=>v,staticGenerationAsyncStorage:()=>f});var t={};o.r(t),o.d(t,{POST:()=>g});var s=o(49303),a=o(88716),n=o(60670),i=o(87070),p=o(36994),u=o(42046),l=o(73824),c=o(58181);let d=49.9/30,m=119.9/30;async function g(e){try{let r=await e.json();console.log("INFO: Mercado Pago Webhook Received:",JSON.stringify(r,null,2));let o=r.type,t=r.data?.id;if("payment"===o&&t){let e=process.env.MP_ACCESS_TOKEN;if(!e)return console.error("CRITICAL: MP_ACCESS_TOKEN n\xe3o est\xe1 configurado no servidor."),i.NextResponse.json({success:!1,message:"Configura\xe7\xe3o do servidor de pagamento incompleta."},{status:200});let r=new p.f7({accessToken:e}),o=new p.F6(r),s=await o.get({id:t});if(console.log(`INFO: Fetched Payment Status for ${t}: ${s.status}`),"approved"===s.status&&s.external_reference){let e;let r=s.external_reference,o=await (0,c.vX)(r);if(!o)return console.error(`ERROR: Webhook - Barbershop with ID ${r} not found.`),i.NextResponse.json({success:!1,message:`Barbershop ${r} not found.`},{status:200});if("Premium"===o.plan)return console.log(`INFO: Barbershop ${r} is already on the Premium plan. No update needed.`),i.NextResponse.json({success:!0,message:"Plan is already Premium."},{status:200});let t=s.transaction_amount||0,a=o.expiryDate?new Date(o.expiryDate):null,n=new Date;if(a&&a>n){let r=(0,u.j)(a,n);e=(0,l.E)(n,Math.floor((r*d+t)/m))}else e=(0,l.E)(n,Math.floor(t/m));await (0,c.Ye)(r,{plan:"Premium",status:"Ativa",expiryDate:e}),console.log(`SUCCESS: Premium plan activated for barbershop: ${r}. Valid until: ${e.toLocaleDateString()}`)}else console.log(`INFO: Payment ${t} not approved or no external reference. Status: ${s.status}`)}return i.NextResponse.json({success:!0,message:"Webhook received."},{status:200})}catch(e){return console.error("ERROR: Could not process Mercado Pago webhook:",e),i.NextResponse.json({success:!1,message:"Internal server error.",error:e.message},{status:500})}}let h=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/webhooks/mercadopago/route",pathname:"/api/webhooks/mercadopago",filename:"route",bundlePath:"app/api/webhooks/mercadopago/route"},resolvedPagePath:"/var/www/barberflow/src/app/api/webhooks/mercadopago/route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:x,staticGenerationAsyncStorage:f,serverHooks:v}=h,w="/api/webhooks/mercadopago/route";function b(){return(0,n.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:f})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var o=e=>r(r.s=e),t=r.X(0,[8948,5972,86,6994,2533],()=>o(47463));module.exports=t})();