"use strict";(()=>{var t={};t.id=1968,t.ids=[1968],t.modules={53524:t=>{t.exports=require("@prisma/client")},20399:t=>{t.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:t=>{t.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},44458:(t,e,a)=>{a.r(e),a.d(e,{originalPathname:()=>h,patchFetch:()=>f,requestAsyncStorage:()=>u,routeModule:()=>d,serverHooks:()=>c,staticGenerationAsyncStorage:()=>m});var r={};a.r(r),a.d(r,{DELETE:()=>p});var n=a(49303),s=a(88716),o=a(60670),i=a(87070),l=a(11803);async function p(t,{params:e}){if(!e?.id)return i.NextResponse.json({error:"ID e obrigatorio."},{status:400});try{return await (0,l.Yt)(e.id),i.NextResponse.json({success:!0})}catch(t){return console.error("DELETE /api/reminders/queue/:id error:",t),i.NextResponse.json({error:t?.message||"Erro ao cancelar o disparo."},{status:500})}}let d=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/reminders/queue/[id]/route",pathname:"/api/reminders/queue/[id]",filename:"route",bundlePath:"app/api/reminders/queue/[id]/route"},resolvedPagePath:"/var/www/barberflow/src/app/api/reminders/queue/[id]/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:u,staticGenerationAsyncStorage:m,serverHooks:c}=d,h="/api/reminders/queue/[id]/route";function f(){return(0,o.patchFetch)({serverHooks:c,staticGenerationAsyncStorage:m})}},63841:(t,e,a)=>{a.d(e,{Z:()=>n});var r=a(53524);let n=globalThis.prisma??new r.PrismaClient({log:["error"]})},11803:(t,e,a)=>{a.d(e,{pr:()=>w,Mu:()=>h,ip:()=>f,qK:()=>E,Yt:()=>I,Yu:()=>y,ZD:()=>c});var r=a(63841);let n=[];function s(t){let e=new Date,a=n.findIndex(e=>e.appointmentId===t.appointmentId&&e.templateType===t.templateType);if(a>=0){let r=n[a];return"sent"===r.status?r:(n[a]={...r,scheduledFor:t.scheduledFor,status:t.status??r.status,attempts:t.attempts??r.attempts,lastError:void 0===t.lastError?r.lastError:t.lastError,sentAt:t.sentAt??r.sentAt??null,updatedAt:e},n[a])}let r={id:t.id||`${Date.now()}-${Math.random().toString(36).slice(2)}`,barbershopId:t.barbershopId,appointmentId:t.appointmentId,templateType:t.templateType,scheduledFor:t.scheduledFor,status:t.status??"pending",attempts:t.attempts??0,lastError:void 0===t.lastError?null:t.lastError,sentAt:t.sentAt??null,createdAt:e,updatedAt:e};return n.unshift(r),r}function o(t,e){return n.filter(a=>a.barbershopId===t&&"pending"===a.status&&a.scheduledFor.getTime()<=e.getTime()).sort((t,e)=>t.scheduledFor.getTime()-e.scheduledFor.getTime())}function i(t,e){return n.filter(a=>a.barbershopId===t&&(!e||a.status===e)).sort((t,e)=>t.scheduledFor.getTime()-e.scheduledFor.getTime())}function l(t,e){let a=n.findIndex(e=>e.id===t);if(a<0)return;let r=n[a];n[a]={...r,status:e.status??r.status,attempts:e.attempts??r.attempts,lastError:void 0===e.lastError?r.lastError:e.lastError,sentAt:void 0===e.sentAt?r.sentAt:e.sentAt,updatedAt:new Date}}function p(t,e,a){let r=new Date;for(let s of n)s.appointmentId===t&&s.templateType===e&&(s.status="cancelled",s.lastError=a||s.lastError,s.updatedAt=r)}function d(t,e){for(let a=n.length-1;a>=0;a-=1){let r=n[a];r.appointmentId!==t||e&&r.templateType!==e||n.splice(a,1)}}function u(t){let e=n.findIndex(e=>e.id===t);e>=0&&n.splice(e,1)}function m(){return r.Z.whatsappmessagequeue}async function c(t){let e=m();if(!e){console.warn("Modelo whatsappmessagequeue nao encontrado. Usando fila em memoria."),s({...t,status:t.status??"pending",attempts:0,lastError:null,sentAt:null});return}try{let a=await e.findUnique({where:{appointmentId_templateType:{appointmentId:t.appointmentId,templateType:t.templateType}}});if(a?.status==="sent")return;if(a){await e.update({where:{id:a.id},data:{scheduledFor:t.scheduledFor,status:t.status??a.status,attempts:a.attempts,lastError:a.lastError,sentAt:a.sentAt}});return}await e.create({data:{barbershopId:t.barbershopId,appointmentId:t.appointmentId,templateType:t.templateType,scheduledFor:t.scheduledFor,status:t.status??"pending",attempts:0}})}catch(e){console.warn("Falha ao gravar fila no banco. Usando fila em memoria.",e),s({...t,status:t.status??"pending",attempts:0,lastError:null,sentAt:null})}}async function h(t,e){let a=m();if(!a)return o(t,e);try{return await a.findMany({where:{barbershopId:t,status:"pending",scheduledFor:{lte:e}},orderBy:{scheduledFor:"asc"}})}catch(a){return console.warn("Falha ao ler fila no banco. Usando fila em memoria.",a),o(t,e)}}async function f(t,e){let a=m();if(!a)return i(t,e);try{return await a.findMany({where:{barbershopId:t,...e?{status:e}:{}},orderBy:{scheduledFor:"asc"}})}catch(a){return console.warn("Falha ao ler fila no banco. Usando fila em memoria.",a),i(t,e)}}async function y(t){let e=m();if(!e){l(t.id,{status:t.status,attempts:t.attempts,lastError:t.lastError,sentAt:t.sentAt});return}try{await e.update({where:{id:t.id},data:{status:t.status,attempts:t.attempts,lastError:t.lastError??null,sentAt:t.sentAt??null}})}catch(e){console.warn("Falha ao atualizar fila no banco. Usando fila em memoria.",e),l(t.id,{status:t.status,attempts:t.attempts,lastError:t.lastError,sentAt:t.sentAt})}}async function w(t){let e=m();if(!e){p(t.appointmentId,t.templateType,t.reason);return}try{await e.updateMany({where:{barbershopId:t.barbershopId,appointmentId:t.appointmentId,templateType:t.templateType},data:{status:"cancelled",lastError:t.reason??null}})}catch(e){console.warn("Falha ao cancelar fila no banco. Usando fila em memoria.",e),p(t.appointmentId,t.templateType,t.reason)}}async function E(t){let e=m();if(!e){d(t.appointmentId,t.templateType);return}try{await e.deleteMany({where:{appointmentId:t.appointmentId,...t.templateType?{templateType:t.templateType}:{}}})}catch(e){console.warn("Falha ao remover fila no banco. Usando fila em memoria.",e),d(t.appointmentId,t.templateType)}}async function I(t){let e=m();if(!e){u(t);return}try{await e.delete({where:{id:t}})}catch(e){console.warn("Falha ao remover item da fila no banco. Usando fila em memoria.",e),u(t)}}}};var e=require("../../../../../webpack-runtime.js");e.C(t);var a=t=>e(e.s=t),r=e.X(0,[8948,5972],()=>a(44458));module.exports=r})();