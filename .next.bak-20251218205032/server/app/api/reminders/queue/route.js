"use strict";(()=>{var e={};e.id=3273,e.ids=[3273],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32151:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>g,patchFetch:()=>h,requestAsyncStorage:()=>f,routeModule:()=>m,serverHooks:()=>w,staticGenerationAsyncStorage:()=>c});var r={};a.r(r),a.d(r,{GET:()=>u});var n=a(49303),i=a(88716),o=a(60670),s=a(87070),l=a(11803),p=a(58126),d=a(54496);async function u(e){let t=e.nextUrl.searchParams.get("barbershopId"),a=e.nextUrl.searchParams.get("status"),r="1"===e.nextUrl.searchParams.get("sync");if(!t)return s.NextResponse.json({data:[],error:"barbershopId e obrigatorio."},{status:400});try{if(r)try{await (0,d.RH)(t)}catch(e){console.warn("Falha ao sincronizar fila:",e)}let e=await (0,l.ip)(t,a&&"all"!==a?a:void 0),n=Array.from(new Set(e.map(e=>e.appointmentId))).filter(e=>!!e),i=await (0,p.ff)(n),o=new Map(i.map(e=>[e.id,e])),u=e.map(e=>{let t=o.get(e.appointmentId);return{id:e.id,appointmentId:e.appointmentId,templateType:e.templateType,scheduledFor:e.scheduledFor,status:e.status,attempts:e.attempts,lastError:e.lastError??null,clientName:t?.clientName||"",clientPhone:t?.clientPhone||"",appointmentStart:t?.startTime||null}});return s.NextResponse.json({data:u})}catch(e){return console.error("Erro ao listar fila de lembretes:",e),s.NextResponse.json({data:[],error:e?.message||"Erro ao listar fila de lembretes."},{status:200})}}let m=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/reminders/queue/route",pathname:"/api/reminders/queue",filename:"route",bundlePath:"app/api/reminders/queue/route"},resolvedPagePath:"/var/www/barberflow/src/app/api/reminders/queue/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:f,staticGenerationAsyncStorage:c,serverHooks:w}=m,g="/api/reminders/queue/route";function h(){return(0,o.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:c})}},54496:(e,t,a)=>{a.d(t,{RH:()=>g,qe:()=>f,w0:()=>w});var r=a(6961),n=a(58181),i=a(58126),o=a(11803),s=a(1624);let l="lembrete",p="pesquisa",d=e=>(0,s.dU)(r.pe,e??[]);function u(e,t,a={}){let r=e.find(e=>{let r=(0,s.bY)(e,t),n=!a.requireEnabled||e.enabled;return r&&n});return!r||a.requireReminderHours&&("number"!=typeof r.reminderHoursBefore||r.reminderHoursBefore<=0)?null:r}function m(e,t){let a=new Set;return e.forEach(e=>{(0,s.bY)(e,t)&&(e.type&&a.add(e.type),e.name&&a.add(e.name))}),Array.from(a)}async function f(e){if(!e.barbershopId)return;let t=await (0,n.vX)(e.barbershopId);if(!t)return;let a=d(t.messageTemplates);await c(e,a,e.barbershopId)}async function c(e,t,a){if(!a)return;let r=u(t,l,{requireEnabled:!0,requireReminderHours:!0}),n=u(t,p,{requireEnabled:!0}),i=m(t,l),d=m(t,p),f=r?(0,s.M8)(r,l):null,c=n?(0,s.M8)(n,p):null;f&&c&&(0,s.s0)(f)===(0,s.s0)(c)&&(c=n?.name&&(0,s.s0)(n.name)!==(0,s.s0)(f)?n.name:`${c} (Pesquisa)`);let w="cancelled"===e.status,g="completed"===e.status;if(w){let t=new Set([...i,f].filter(Boolean)),r=new Set([...d,c].filter(Boolean));for(let r of t)await (0,o.pr)({barbershopId:a,appointmentId:e.id,templateType:r,reason:"Agendamento cancelado."});for(let t of r)await (0,o.pr)({barbershopId:a,appointmentId:e.id,templateType:t,reason:"Agendamento cancelado."});return}let h=new Date(e.startTime);if(r&&f&&!g){let t=new Date(h.getTime()-36e5*r.reminderHoursBefore),n=new Date;if(t.getTime()<=n.getTime())for(let t of new Set([...i,f].filter(Boolean)))await (0,o.pr)({barbershopId:a,appointmentId:e.id,templateType:t,reason:`Lembrete nao enviado: agendamento com menos de ${r.reminderHoursBefore} hora(s) de antecedencia.`});else await (0,o.ZD)({barbershopId:a,appointmentId:e.id,templateType:f,scheduledFor:t,status:"pending"})}else if(i.length>0||f)for(let t of new Set([...i,f].filter(Boolean)))await (0,o.pr)({barbershopId:a,appointmentId:e.id,templateType:t,reason:g?"Agendamento finalizado.":"Lembrete desativado ou sem horario configurado."});if(n&&c){let t=new Date(h.getTime()+864e5);await (0,o.ZD)({barbershopId:a,appointmentId:e.id,templateType:c,scheduledFor:t,status:"pending"})}else if(d.length>0||c)for(let t of new Set([...d,c].filter(Boolean)))await (0,o.pr)({barbershopId:a,appointmentId:e.id,templateType:t,reason:"Pesquisa desativada."})}async function w(e){await (0,o.qK)({appointmentId:e})}async function g(e){if(!e)return;let t=await (0,n.vX)(e);if(!t)return;let a=d(t.messageTemplates),r=new Date(new Date().getTime()-864e5);for(let t of(await (0,i.PD)(e,r)))await c(t,a,e)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972,86,4188],()=>a(32151));module.exports=r})();