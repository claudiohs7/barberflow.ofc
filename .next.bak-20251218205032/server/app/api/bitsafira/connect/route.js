"use strict";(()=>{var e={};e.id=5933,e.ids=[5933],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},95124:(e,a,t)=>{t.r(a),t.d(a,{originalPathname:()=>g,patchFetch:()=>b,requestAsyncStorage:()=>f,routeModule:()=>p,serverHooks:()=>I,staticGenerationAsyncStorage:()=>m});var n={};t.r(n),t.d(n,{POST:()=>u});var r=t(49303),s=t(88716),o=t(60670),i=t(87070),c=t(21762),d=t(30954),l=t(58181);async function u(e){try{let{barbershopId:a}=await e.json();if(!a)return i.NextResponse.json({message:"ID da barbearia e obrigatorio."},{status:400});let t=await (0,l.vX)(a);if(!t){let e=await (0,l.XX)(a);t=e?.[0]??null}if(!t)return console.error(`Barbearia com ID ${a} nao encontrada.`),i.NextResponse.json({message:`Barbearia com ID ${a} nao encontrada.`},{status:404});let n=t.bitSafiraToken||process.env.BITSAFIRA_TOKEN;if(!n)return console.error("BITSAFIRA_TOKEN nao configurado para a barbearia ou no ambiente."),i.NextResponse.json({message:"Token da BitSafira nao configurado."},{status:500});let r=(0,c.q)(n),s="http://localhost:3000".replace(/\/$/,""),o=`${s}/api/webhooks/bitsafira`,u=t.email?`${t.name||"BarberFlow"}-${t.email}`:`${t.name||"BarberFlow"}-${t.id}`,p=t.bitsafiraInstanceId,f=(0,d.I6)(t.whatsappStatus),m=t.qrCodeBase64||null,I=null;if(console.log(`[${a}] Iniciando conexao BitSafira. Instancia: ${p||"N/A"}, status: ${f}`),p)try{let e=await r.getInstanceInfo(p);if(200===e.status&&e.dados){let t=e.dados,s=t.descricao;if("string"!=typeof s||s!==u)try{let e={id:p,urlWebhook:o,descricao:u,token:n},t=await r.createInstance(e);console.log(`[${a}] Descricao da instancia atualizada:`,t)}catch(e){console.warn(`[${a}] Nao foi possivel atualizar descricao da instancia:`,e?.message)}let i=(0,d.zC)(t),c=(0,d.I6)(i);console.log(`[${a}] Instancia ${p} encontrada. Status: ${i} (normalizado: ${c})`),f=c,"CONNECTED"===c&&(m=null)}else console.warn(`[${a}] Instancia ${p} nao encontrada (status ${e.status}). Tentaremos reconectar.`)}catch(e){console.error(`[${a}] Erro ao consultar instancia ${p}:`,e.message)}else{let e={id:"",urlWebhook:o,descricao:u,token:n};console.log(`[${a}] Nenhuma instancia registrada. Criando nova inst\xe2ncia. Payload:`,e);let s=await r.createInstance(e);if(console.log(`[${a}] Resposta da criacao da instancia:`,s),![200,201].includes(s.status)||!s.dados||!s.dados.id)return console.error(`[${a}] Falha ao criar inst\xe2ncia BitSafira:`,s.mensagem||s.message),await (0,l.Ye)(t.id,{whatsappStatus:"ERROR"}),i.NextResponse.json({message:"Falha ao criar instancia BitSafira."},{status:500});p=s.dados.id,I=s.dados,console.log(`[${a}] Instancia criada com sucesso. ID: ${p}`)}if(p){let e={id:p};console.log(`[${a}] Conectando instancia BitSafira com ID ${p} para obter QR.`);let n=await r.connectInstance(e);if(console.log(`[${a}] Resposta da conexao:`,n),200===n.status&&n.dados){let e=n.dados,t=(0,d.zC)(e)??f,r=(0,d.I6)(t);console.log(`[${a}] Status retornado pela conexao: ${t} (normalizado: ${r})`),f=r,m=(0,d.K1)(e.qrCode||e.qr)??m,"CONNECTED"===r&&(m=null),I={...I||{},...e}}else console.error(`[${a}] Falha ao conectar instancia ou obter QR Code:`,n.mensagem||n.message),f="ERROR",m=null;return await (0,l.Ye)(t.id,{bitsafiraInstanceId:p,whatsappStatus:f,qrCodeBase64:m,bitsafiraInstanceData:I??void 0}),i.NextResponse.json({message:"Processo de conexao BitSafira concluido.",instanceId:p,whatsappStatus:f,qrCodeBase64:m},{status:200})}return i.NextResponse.json({message:"Nao foi possivel obter ou criar uma instancia BitSafira."},{status:500})}catch(e){return console.error("Erro na rota /api/bitsafira/connect:",e),i.NextResponse.json({message:"Erro interno do servidor.",error:e.message},{status:500})}}let p=new r.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/bitsafira/connect/route",pathname:"/api/bitsafira/connect",filename:"route",bundlePath:"app/api/bitsafira/connect/route"},resolvedPagePath:"/var/www/barberflow/src/app/api/bitsafira/connect/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:f,staticGenerationAsyncStorage:m,serverHooks:I}=p,g="/api/bitsafira/connect/route";function b(){return(0,o.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:m})}},21762:(e,a,t)=>{t.d(a,{q:()=>r});class n{constructor(e){this.token=e.token,this.baseUrl=e.baseUrl||"https://api.bitsafira.com.br"}async request(e,a,t){let n={method:e,headers:{"Content-Type":"application/json",Token:this.token},redirect:"follow"};t&&(n.body=JSON.stringify(t));try{let e=await fetch(`${this.baseUrl}${a}`,n),t=await e.json();return{status:e.status,message:t.message||t.mensagem,mensagem:t.mensagem,error:t.error,dados:t.dados||t}}catch(t){return console.error(`BitSafira API Error [${e} ${a}]:`,t),{status:500,message:"Erro de comunica\xe7\xe3o com a API BitSafira.",error:t.message}}}async authenticate(e){return this.request("POST","/auth",e)}async listInstances(){return this.request("GET","/instancias")}async getInstanceInfo(e){return this.request("GET",`/instancia/info?id=${encodeURIComponent(e)}`)}async createInstance(e){return this.request("POST","/instancia/salvar",e)}async deleteInstance(e){return this.request("DELETE","/instancia/deletar",e)}async connectInstance(e){return this.request("POST","/instancia/conectar",e)}async disconnectInstance(e){return this.request("POST","/instancia/desconectar",e)}async sendMessage(e){let a=await this.request("POST","/disparo/enviar",e);if(404!==a.status)return a;let t=await this.request("POST","/mensagem/disparar",e);return 404!==t.status?t:this.request("POST","/mensagem/enviar",e)}async verifyNumber(e){return this.request("POST","/numero/verificar",e)}}function r(e){let a=e||process.env.BITSAFIRA_TOKEN,t=process.env.BITSAFIRA_BASE_URL;if(!a)throw Error("BITSAFIRA_TOKEN is not defined in environment variables or provided.");return new n({token:a,baseUrl:t})}},30954:(e,a,t)=>{t.d(a,{I6:()=>s,K1:()=>i,zC:()=>o});let n=new Set(["CONNECTED","WORKING"]),r=new Set(["AWAITING_SCAN","SCAN_QR_CODE","LOADING_QR","SCAN_QRCODE"]);function s(e){if(!e)return"DISCONNECTED";let a=e.toUpperCase();return n.has(a)?"CONNECTED":r.has(a)?"AWAITING_SCAN":"TIMEOUT"===a?"TIMEOUT":"ERROR"===a?"ERROR":"DISCONNECTED"}function o(e){if(e)return e.status??e.conexao?.status}function i(e){if(!e)return null;let a=e.trim(),t=a.indexOf(",");return t>=0?a.slice(t+1):a}},40644:(e,a,t)=>{t.d(a,{cn:()=>s,lV:()=>i,xG:()=>o});var n=t(55761),r=t(62386);function s(...e){return(0,r.m6)((0,n.W)(e))}function o(e){return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(e)}function i(e){return e?e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").replace(/-{2,}/g,"-"):""}},63841:(e,a,t)=>{t.d(a,{Z:()=>r});var n=t(53524);let r=globalThis.prisma??new n.PrismaClient({log:["error"]})},58181:(e,a,t)=>{t.d(a,{JN:()=>m,Pz:()=>I,XX:()=>g,Ye:()=>u,_6:()=>b,kn:()=>f,uq:()=>l,vX:()=>p});var n=t(63841),r=t(40644);function s(e){return e&&e.toLowerCase().includes("prem")?"PREMIUM":"BASIC"}function o(e){return(e||"").replace(/\D/g,"")}function i(e){if(!e)return;if(e instanceof Date)return e;let a=new Date(e);return Number.isNaN(a.getTime())?void 0:a}async function c(e,a){return(await n.Z.barbershop.findMany({where:{cpfCnpj:{not:null},...a?{NOT:{id:a}}:{}},select:{id:!0,cpfCnpj:!0}})).find(a=>o(a.cpfCnpj??"")===e)}function d(e){return{id:e.id,name:e.name,legalName:e.legalName??void 0,cpfCnpj:e.cpfCnpj??void 0,email:e.email??void 0,phone:e.phone??void 0,description:e.description??void 0,ownerId:e.ownerId??void 0,plan:"PREMIUM"===e.plan?"Premium":"B\xe1sico",status:e.status,expiryDate:e.expiryDate?.toISOString(),address:e.addressJson??void 0,operatingHours:e.operatingHoursJson??void 0,logoUrl:e.logoUrl??void 0,whatsappStatus:e.whatsappStatus,qrCodeBase64:e.qrCodeBase64??void 0,bitsafiraInstanceId:e.bitsafiraInstanceId??void 0,bitSafiraToken:e.bitSafiraToken??void 0,whatsAppInstanceId:e.whatsAppInstanceId??void 0,messageTemplates:e.messageTemplates?.map(e=>({id:e.id,name:e.name,content:e.content,enabled:e.enabled,type:e.type,reminderHoursBefore:e.reminderHoursBefore??null}))||[],bitsafiraInstanceData:e.bitsafiraInstanceData??void 0,createdAt:e.createdAt?.toISOString()}}async function l(e){let a=e.id||crypto.randomUUID(),t=o(e.cpfCnpj),r=i(e.expiryDate);if(t&&await c(t))throw Error("CPF/CNPJ j\xe1 est\xe1 cadastrado para outra barbearia.");return d(await n.Z.barbershop.create({data:{id:a,name:e.name,legalName:e.legalName,cpfCnpj:t||e.cpfCnpj,email:e.email,phone:e.phone,description:e.description,ownerId:e.ownerId,plan:s(e.plan),status:e.status,expiryDate:r,addressJson:e.address?e.address:void 0,operatingHoursJson:e.operatingHours?e.operatingHours:void 0,logoUrl:e.logoUrl,whatsappStatus:e.whatsappStatus,qrCodeBase64:e.qrCodeBase64,bitsafiraInstanceId:e.bitsafiraInstanceId??void 0,bitSafiraToken:e.bitSafiraToken??void 0,whatsAppInstanceId:e.whatsAppInstanceId??void 0,bitsafiraInstanceData:e.bitsafiraInstanceData??void 0},include:{messageTemplates:!0}}))}async function u(e,a){let t=o(a.cpfCnpj);if(t&&await c(t,e))throw Error("CPF/CNPJ j\xe1 est\xe1 cadastrado para outra barbearia.");let r=i(a.expiryDate);return d(await n.Z.barbershop.update({where:{id:e},data:{name:a.name,legalName:a.legalName,cpfCnpj:t||a.cpfCnpj,email:a.email,phone:a.phone,description:a.description,ownerId:a.ownerId,plan:a.plan?s(a.plan):void 0,status:a.status,expiryDate:r,addressJson:a.address?a.address:void 0,operatingHoursJson:a.operatingHours?a.operatingHours:void 0,logoUrl:a.logoUrl,whatsappStatus:a.whatsappStatus,qrCodeBase64:a.qrCodeBase64,bitsafiraInstanceId:a.bitsafiraInstanceId,bitSafiraToken:a.bitSafiraToken,whatsAppInstanceId:a.whatsAppInstanceId,bitsafiraInstanceData:a.bitsafiraInstanceData},include:{messageTemplates:!0}}))}async function p(e){let a=await n.Z.barbershop.findUnique({where:{id:e},include:{messageTemplates:!0}});return a?d(a):null}async function f(e){let a=await p(e);if(a)return a;let t=(0,r.lV)(e||"");if(!t)return null;let s=(await n.Z.barbershop.findMany({include:{messageTemplates:!0}})).find(e=>(0,r.lV)(e.name)===t);return s?d(s):null}async function m(e){let a=await n.Z.barbershop.findFirst({where:{bitsafiraInstanceId:e},include:{messageTemplates:!0}});return a?d(a):null}async function I(){return(await n.Z.barbershop.findMany({orderBy:{createdAt:"desc"},include:{messageTemplates:!0}})).map(d)}async function g(e){return(await n.Z.barbershop.findMany({where:{ownerId:e},orderBy:{createdAt:"desc"},include:{messageTemplates:!0}})).map(d)}async function b(e){await n.Z.barbershop.delete({where:{id:e}})}}};var a=require("../../../../webpack-runtime.js");a.C(e);var t=e=>a(a.s=e),n=a.X(0,[8948,5972,86],()=>t(95124));module.exports=n})();