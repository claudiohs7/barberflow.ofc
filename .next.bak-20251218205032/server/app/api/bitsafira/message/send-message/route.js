"use strict";(()=>{var e={};e.id=2491,e.ids=[2491],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},56255:(e,a,t)=>{t.r(a),t.d(a,{originalPathname:()=>h,patchFetch:()=>I,requestAsyncStorage:()=>m,routeModule:()=>u,serverHooks:()=>f,staticGenerationAsyncStorage:()=>g});var s={};t.r(s),t.d(s,{POST:()=>p});var n=t(49303),r=t(88716),i=t(60670),o=t(87070),c=t(21762),d=t(58181),l=t(26003);async function p(e){try{let{barbershopId:a,number:t,message:s,clientName:n,messageType:r,appointmentId:i}=await e.json();if(console.log("--- Requisi\xe7\xe3o POST recebida em /api/bitsafira/message/send-message ---"),console.log(`Barbershop ID: ${a}, N\xfamero: ${t}, Mensagem: ${s.substring(0,50)}...`),!a||!t||!s)return o.NextResponse.json({success:!1,message:"ID da barbearia, n\xfamero e mensagem s\xe3o obrigat\xf3rios."},{status:400});let p=await (0,d.vX)(a);if(!p)return o.NextResponse.json({success:!1,message:`Barbearia com ID ${a} n\xe3o encontrada.`},{status:404});let u=p.bitSafiraToken||process.env.BITSAFIRA_TOKEN,m=p.bitsafiraInstanceId||process.env.BITSAFIRA_INSTANCE_ID;if(!u||!m)return o.NextResponse.json({success:!1,message:"Token ou ID da inst\xe2ncia BitSafira n\xe3o configurados."},{status:400});let g=(0,c.q)(u),f=t.replace(/\D/g,""),h=f.startsWith("55")?f:`55${f}`,I={idInstancia:m,whatsapp:h,texto:s,envioImediato:1};console.log("Payload para enviar mensagem:",JSON.stringify(I,null,2));let b=await g.sendMessage(I);console.log("Resultado do envio da mensagem (bitsafira.sendMessage):",b);let w=new Date;if([200,201].includes(b.status)&&b.dados){try{await (0,l.C)([{barbershopId:a,appointmentId:i??null,clientName:n||null,clientPhone:h,templateType:r||"Mensagem manual",status:"success",message:s,sentAt:w}])}catch(e){console.warn("Falha ao registrar log do WhatsApp:",e)}return o.NextResponse.json({success:!0,message:b.dados.mensagem,data:b.dados},{status:200})}try{await (0,l.C)([{barbershopId:a,appointmentId:i??null,clientName:n||null,clientPhone:h,templateType:r||"Mensagem manual",status:"error",message:b.mensagem||"Falha ao enviar mensagem.",sentAt:w}])}catch(e){console.warn("Falha ao registrar log do WhatsApp:",e)}return o.NextResponse.json({success:!1,message:b.mensagem||"Falha ao enviar mensagem."},{status:b.status||500})}catch(e){return console.error("Erro na API /api/bitsafira/message/send-message:",e),o.NextResponse.json({success:!1,message:"Erro interno no servidor.",error:e.message||"Erro desconhecido."},{status:500})}}let u=new n.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/bitsafira/message/send-message/route",pathname:"/api/bitsafira/message/send-message",filename:"route",bundlePath:"app/api/bitsafira/message/send-message/route"},resolvedPagePath:"/var/www/barberflow/src/app/api/bitsafira/message/send-message/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:f}=u,h="/api/bitsafira/message/send-message/route";function I(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:g})}},21762:(e,a,t)=>{t.d(a,{q:()=>n});class s{constructor(e){this.token=e.token,this.baseUrl=e.baseUrl||"https://api.bitsafira.com.br"}async request(e,a,t){let s={method:e,headers:{"Content-Type":"application/json",Token:this.token},redirect:"follow"};t&&(s.body=JSON.stringify(t));try{let e=await fetch(`${this.baseUrl}${a}`,s),t=await e.json();return{status:e.status,message:t.message||t.mensagem,mensagem:t.mensagem,error:t.error,dados:t.dados||t}}catch(t){return console.error(`BitSafira API Error [${e} ${a}]:`,t),{status:500,message:"Erro de comunica\xe7\xe3o com a API BitSafira.",error:t.message}}}async authenticate(e){return this.request("POST","/auth",e)}async listInstances(){return this.request("GET","/instancias")}async getInstanceInfo(e){return this.request("GET",`/instancia/info?id=${encodeURIComponent(e)}`)}async createInstance(e){return this.request("POST","/instancia/salvar",e)}async deleteInstance(e){return this.request("DELETE","/instancia/deletar",e)}async connectInstance(e){return this.request("POST","/instancia/conectar",e)}async disconnectInstance(e){return this.request("POST","/instancia/desconectar",e)}async sendMessage(e){let a=await this.request("POST","/disparo/enviar",e);if(404!==a.status)return a;let t=await this.request("POST","/mensagem/disparar",e);return 404!==t.status?t:this.request("POST","/mensagem/enviar",e)}async verifyNumber(e){return this.request("POST","/numero/verificar",e)}}function n(e){let a=e||process.env.BITSAFIRA_TOKEN,t=process.env.BITSAFIRA_BASE_URL;if(!a)throw Error("BITSAFIRA_TOKEN is not defined in environment variables or provided.");return new s({token:a,baseUrl:t})}},40644:(e,a,t)=>{t.d(a,{cn:()=>r,lV:()=>o,xG:()=>i});var s=t(55761),n=t(62386);function r(...e){return(0,n.m6)((0,s.W)(e))}function i(e){return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(e)}function o(e){return e?e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").replace(/-{2,}/g,"-"):""}},63841:(e,a,t)=>{t.d(a,{Z:()=>n});var s=t(53524);let n=globalThis.prisma??new s.PrismaClient({log:["error"]})},58181:(e,a,t)=>{t.d(a,{JN:()=>g,Pz:()=>f,XX:()=>h,Ye:()=>p,_6:()=>I,kn:()=>m,uq:()=>l,vX:()=>u});var s=t(63841),n=t(40644);function r(e){return e&&e.toLowerCase().includes("prem")?"PREMIUM":"BASIC"}function i(e){return(e||"").replace(/\D/g,"")}function o(e){if(!e)return;if(e instanceof Date)return e;let a=new Date(e);return Number.isNaN(a.getTime())?void 0:a}async function c(e,a){return(await s.Z.barbershop.findMany({where:{cpfCnpj:{not:null},...a?{NOT:{id:a}}:{}},select:{id:!0,cpfCnpj:!0}})).find(a=>i(a.cpfCnpj??"")===e)}function d(e){return{id:e.id,name:e.name,legalName:e.legalName??void 0,cpfCnpj:e.cpfCnpj??void 0,email:e.email??void 0,phone:e.phone??void 0,description:e.description??void 0,ownerId:e.ownerId??void 0,plan:"PREMIUM"===e.plan?"Premium":"B\xe1sico",status:e.status,expiryDate:e.expiryDate?.toISOString(),address:e.addressJson??void 0,operatingHours:e.operatingHoursJson??void 0,logoUrl:e.logoUrl??void 0,whatsappStatus:e.whatsappStatus,qrCodeBase64:e.qrCodeBase64??void 0,bitsafiraInstanceId:e.bitsafiraInstanceId??void 0,bitSafiraToken:e.bitSafiraToken??void 0,whatsAppInstanceId:e.whatsAppInstanceId??void 0,messageTemplates:e.messageTemplates?.map(e=>({id:e.id,name:e.name,content:e.content,enabled:e.enabled,type:e.type,reminderHoursBefore:e.reminderHoursBefore??null}))||[],bitsafiraInstanceData:e.bitsafiraInstanceData??void 0,createdAt:e.createdAt?.toISOString()}}async function l(e){let a=e.id||crypto.randomUUID(),t=i(e.cpfCnpj),n=o(e.expiryDate);if(t&&await c(t))throw Error("CPF/CNPJ j\xe1 est\xe1 cadastrado para outra barbearia.");return d(await s.Z.barbershop.create({data:{id:a,name:e.name,legalName:e.legalName,cpfCnpj:t||e.cpfCnpj,email:e.email,phone:e.phone,description:e.description,ownerId:e.ownerId,plan:r(e.plan),status:e.status,expiryDate:n,addressJson:e.address?e.address:void 0,operatingHoursJson:e.operatingHours?e.operatingHours:void 0,logoUrl:e.logoUrl,whatsappStatus:e.whatsappStatus,qrCodeBase64:e.qrCodeBase64,bitsafiraInstanceId:e.bitsafiraInstanceId??void 0,bitSafiraToken:e.bitSafiraToken??void 0,whatsAppInstanceId:e.whatsAppInstanceId??void 0,bitsafiraInstanceData:e.bitsafiraInstanceData??void 0},include:{messageTemplates:!0}}))}async function p(e,a){let t=i(a.cpfCnpj);if(t&&await c(t,e))throw Error("CPF/CNPJ j\xe1 est\xe1 cadastrado para outra barbearia.");let n=o(a.expiryDate);return d(await s.Z.barbershop.update({where:{id:e},data:{name:a.name,legalName:a.legalName,cpfCnpj:t||a.cpfCnpj,email:a.email,phone:a.phone,description:a.description,ownerId:a.ownerId,plan:a.plan?r(a.plan):void 0,status:a.status,expiryDate:n,addressJson:a.address?a.address:void 0,operatingHoursJson:a.operatingHours?a.operatingHours:void 0,logoUrl:a.logoUrl,whatsappStatus:a.whatsappStatus,qrCodeBase64:a.qrCodeBase64,bitsafiraInstanceId:a.bitsafiraInstanceId,bitSafiraToken:a.bitSafiraToken,whatsAppInstanceId:a.whatsAppInstanceId,bitsafiraInstanceData:a.bitsafiraInstanceData},include:{messageTemplates:!0}}))}async function u(e){let a=await s.Z.barbershop.findUnique({where:{id:e},include:{messageTemplates:!0}});return a?d(a):null}async function m(e){let a=await u(e);if(a)return a;let t=(0,n.lV)(e||"");if(!t)return null;let r=(await s.Z.barbershop.findMany({include:{messageTemplates:!0}})).find(e=>(0,n.lV)(e.name)===t);return r?d(r):null}async function g(e){let a=await s.Z.barbershop.findFirst({where:{bitsafiraInstanceId:e},include:{messageTemplates:!0}});return a?d(a):null}async function f(){return(await s.Z.barbershop.findMany({orderBy:{createdAt:"desc"},include:{messageTemplates:!0}})).map(d)}async function h(e){return(await s.Z.barbershop.findMany({where:{ownerId:e},orderBy:{createdAt:"desc"},include:{messageTemplates:!0}})).map(d)}async function I(e){await s.Z.barbershop.delete({where:{id:e}})}},26003:(e,a,t)=>{t.d(a,{C:()=>i,U:()=>o});var s=t(63841);let n=[];function r(e){return e?n.filter(a=>a.barbershopId===e):n}async function i(e){if(!e.length)return;let a=()=>{var a;a=e.map(e=>({id:e.id||`${Date.now()}-${Math.random().toString(36).slice(2)}`,barbershopId:e.barbershopId,appointmentId:e.appointmentId??null,clientName:e.clientName??void 0,clientPhone:e.clientPhone??void 0,templateType:e.templateType??void 0,status:e.status,message:e.message,sentAt:(e.sentAt?new Date(e.sentAt):new Date).toISOString(),details:e.details??void 0})),n.unshift(...a),n.length>200&&(n.length=200)},t=s.Z.whatsappmessagelog;if(!t){console.warn("Modelo whatsappmessagelog nao encontrado. Usando log em memoria."),a();return}let r=e.map(e=>({...e.id?{id:e.id}:{},barbershopId:e.barbershopId,appointmentId:e.appointmentId??null,clientName:e.clientName??null,clientPhone:e.clientPhone??null,templateType:e.templateType??null,status:e.status,message:e.message,sentAt:e.sentAt?new Date(e.sentAt):new Date,details:e.details??null}));try{await t.createMany({data:r})}catch(e){console.warn("Falha ao gravar logs no banco. Usando log em memoria.",e),a()}}async function o(e){let a=s.Z.whatsappmessagelog;if(!a)return r(e);try{return a.findMany({where:e?{barbershopId:e}:void 0,orderBy:{sentAt:"desc"}})}catch(a){return console.warn("Falha ao ler logs do banco. Usando log em memoria.",a),r(e)}}}};var a=require("../../../../../webpack-runtime.js");a.C(e);var t=e=>a(a.s=e),s=a.X(0,[8948,5972,86],()=>t(56255));module.exports=s})();