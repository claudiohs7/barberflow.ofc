"use strict";(()=>{var e={};e.id=4282,e.ids=[4282],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},19517:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>b,patchFetch:()=>g,requestAsyncStorage:()=>c,routeModule:()=>m,serverHooks:()=>w,staticGenerationAsyncStorage:()=>f});var r={};a.r(r),a.d(r,{GET:()=>l,POST:()=>u});var n=a(49303),o=a(88716),i=a(60670),s=a(87070),p=a(58126),d=a(54496);async function l(e){try{let{searchParams:t}=new URL(e.url),a=t.get("barbershopId");if(!a)return s.NextResponse.json({error:"barbershopId \xe9 obrigat\xf3rio"},{status:400});let r=t.get("from"),n=t.get("to"),o=t.get("clientId")||void 0,i=t.get("barberId")||void 0,d=await (0,p.PD)(a,r?new Date(r):void 0,n?new Date(n):void 0,{clientId:o,barberId:i});return s.NextResponse.json({data:d})}catch(e){return console.error("GET /api/appointments error:",e),s.NextResponse.json({error:"Erro ao listar agendamentos"},{status:500})}}async function u(e){try{let t=await e.json(),a=await (0,p.Pc)({barbershopId:t.barbershopId,barberId:t.barberId,clientId:t.clientId,clientName:t.clientName,clientPhone:t.clientPhone,serviceIds:t.serviceIds,startTime:new Date(t.startTime),endTime:new Date(t.endTime),status:t.status,totalDuration:t.totalDuration});try{await (0,d.qe)(a)}catch(e){console.warn("Falha ao agendar lembrete para o novo agendamento:",e)}return s.NextResponse.json({data:a},{status:201})}catch(e){return console.error("POST /api/appointments error:",e),s.NextResponse.json({error:"Erro ao criar agendamento"},{status:500})}}let m=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/appointments/route",pathname:"/api/appointments",filename:"route",bundlePath:"app/api/appointments/route"},resolvedPagePath:"/var/www/barberflow/src/app/api/appointments/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:c,staticGenerationAsyncStorage:f,serverHooks:w}=m,b="/api/appointments/route";function g(){return(0,i.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:f})}},54496:(e,t,a)=>{a.d(t,{RH:()=>b,qe:()=>c,w0:()=>w});var r=a(6961),n=a(58181),o=a(58126),i=a(11803),s=a(1624);let p="lembrete",d="pesquisa",l=e=>(0,s.dU)(r.pe,e??[]);function u(e,t,a={}){let r=e.find(e=>{let r=(0,s.bY)(e,t),n=!a.requireEnabled||e.enabled;return r&&n});return!r||a.requireReminderHours&&("number"!=typeof r.reminderHoursBefore||r.reminderHoursBefore<=0)?null:r}function m(e,t){let a=new Set;return e.forEach(e=>{(0,s.bY)(e,t)&&(e.type&&a.add(e.type),e.name&&a.add(e.name))}),Array.from(a)}async function c(e){if(!e.barbershopId)return;let t=await (0,n.vX)(e.barbershopId);if(!t)return;let a=l(t.messageTemplates);await f(e,a,e.barbershopId)}async function f(e,t,a){if(!a)return;let r=u(t,p,{requireEnabled:!0,requireReminderHours:!0}),n=u(t,d,{requireEnabled:!0}),o=m(t,p),l=m(t,d),c=r?(0,s.M8)(r,p):null,f=n?(0,s.M8)(n,d):null;c&&f&&(0,s.s0)(c)===(0,s.s0)(f)&&(f=n?.name&&(0,s.s0)(n.name)!==(0,s.s0)(c)?n.name:`${f} (Pesquisa)`);let w="cancelled"===e.status,b="completed"===e.status;if(w){let t=new Set([...o,c].filter(Boolean)),r=new Set([...l,f].filter(Boolean));for(let r of t)await (0,i.pr)({barbershopId:a,appointmentId:e.id,templateType:r,reason:"Agendamento cancelado."});for(let t of r)await (0,i.pr)({barbershopId:a,appointmentId:e.id,templateType:t,reason:"Agendamento cancelado."});return}let g=new Date(e.startTime);if(r&&c&&!b){let t=new Date(g.getTime()-36e5*r.reminderHoursBefore),n=new Date;if(t.getTime()<=n.getTime())for(let t of new Set([...o,c].filter(Boolean)))await (0,i.pr)({barbershopId:a,appointmentId:e.id,templateType:t,reason:`Lembrete nao enviado: agendamento com menos de ${r.reminderHoursBefore} hora(s) de antecedencia.`});else await (0,i.ZD)({barbershopId:a,appointmentId:e.id,templateType:c,scheduledFor:t,status:"pending"})}else if(o.length>0||c)for(let t of new Set([...o,c].filter(Boolean)))await (0,i.pr)({barbershopId:a,appointmentId:e.id,templateType:t,reason:b?"Agendamento finalizado.":"Lembrete desativado ou sem horario configurado."});if(n&&f){let t=new Date(g.getTime()+864e5);await (0,i.ZD)({barbershopId:a,appointmentId:e.id,templateType:f,scheduledFor:t,status:"pending"})}else if(l.length>0||f)for(let t of new Set([...l,f].filter(Boolean)))await (0,i.pr)({barbershopId:a,appointmentId:e.id,templateType:t,reason:"Pesquisa desativada."})}async function w(e){await (0,i.qK)({appointmentId:e})}async function b(e){if(!e)return;let t=await (0,n.vX)(e);if(!t)return;let a=l(t.messageTemplates),r=new Date(new Date().getTime()-864e5);for(let t of(await (0,o.PD)(e,r)))await f(t,a,e)}}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972,86,4188],()=>a(19517));module.exports=r})();