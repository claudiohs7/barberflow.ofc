"use strict";(()=>{var e={};e.id=2499,e.ids=[2499],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},65098:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>g,patchFetch:()=>T,requestAsyncStorage:()=>c,routeModule:()=>u,serverHooks:()=>w,staticGenerationAsyncStorage:()=>f});var r={};a.r(r),a.d(r,{DELETE:()=>m,PATCH:()=>l});var n=a(49303),o=a(88716),i=a(60670),s=a(87070),p=a(58126),d=a(54496);async function l(e,{params:t}){try{let a=await e.json(),r=await (0,p.W$)(t.id,{...a,startTime:a.startTime?new Date(a.startTime):void 0,endTime:a.endTime?new Date(a.endTime):void 0});try{await (0,d.qe)(r)}catch(e){console.warn("Falha ao atualizar lembrete do agendamento:",e)}return s.NextResponse.json({data:r})}catch(e){return console.error("PATCH /api/appointments/:id error:",e),s.NextResponse.json({error:"Erro ao atualizar agendamento"},{status:500})}}async function m(e,{params:t}){try{await (0,p.V2)(t.id);try{await (0,d.w0)(t.id)}catch(e){console.warn("Falha ao remover lembrete do agendamento:",e)}return s.NextResponse.json({success:!0})}catch(e){return console.error("DELETE /api/appointments/:id error:",e),s.NextResponse.json({error:"Erro ao remover agendamento"},{status:500})}}let u=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/appointments/[id]/route",pathname:"/api/appointments/[id]",filename:"route",bundlePath:"app/api/appointments/[id]/route"},resolvedPagePath:"/var/www/barberflow/src/app/api/appointments/[id]/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:c,staticGenerationAsyncStorage:f,serverHooks:w}=u,g="/api/appointments/[id]/route";function T(){return(0,i.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:f})}},54496:(e,t,a)=>{a.d(t,{RH:()=>g,qe:()=>c,w0:()=>w});var r=a(6961),n=a(58181),o=a(58126),i=a(11803),s=a(1624);let p="lembrete",d="pesquisa",l=e=>(0,s.dU)(r.pe,e??[]);function m(e,t,a={}){let r=e.find(e=>{let r=(0,s.bY)(e,t),n=!a.requireEnabled||e.enabled;return r&&n});return!r||a.requireReminderHours&&("number"!=typeof r.reminderHoursBefore||r.reminderHoursBefore<=0)?null:r}function u(e,t){let a=new Set;return e.forEach(e=>{(0,s.bY)(e,t)&&(e.type&&a.add(e.type),e.name&&a.add(e.name))}),Array.from(a)}async function c(e){if(!e.barbershopId)return;let t=await (0,n.vX)(e.barbershopId);if(!t)return;let a=l(t.messageTemplates);await f(e,a,e.barbershopId)}async function f(e,t,a){if(!a)return;let r=m(t,p,{requireEnabled:!0,requireReminderHours:!0}),n=m(t,d,{requireEnabled:!0}),o=u(t,p),l=u(t,d),c=r?(0,s.M8)(r,p):null,f=n?(0,s.M8)(n,d):null;c&&f&&(0,s.s0)(c)===(0,s.s0)(f)&&(f=n?.name&&(0,s.s0)(n.name)!==(0,s.s0)(c)?n.name:`${f} (Pesquisa)`);let w="cancelled"===e.status,g="completed"===e.status;if(w){let t=new Set([...o,c].filter(Boolean)),r=new Set([...l,f].filter(Boolean));for(let r of t)await (0,i.pr)({barbershopId:a,appointmentId:e.id,templateType:r,reason:"Agendamento cancelado."});for(let t of r)await (0,i.pr)({barbershopId:a,appointmentId:e.id,templateType:t,reason:"Agendamento cancelado."});return}let T=new Date(e.startTime);if(r&&c&&!g){let t=new Date(T.getTime()-36e5*r.reminderHoursBefore),n=new Date;if(t.getTime()<=n.getTime())for(let t of new Set([...o,c].filter(Boolean)))await (0,i.pr)({barbershopId:a,appointmentId:e.id,templateType:t,reason:`Lembrete nao enviado: agendamento com menos de ${r.reminderHoursBefore} hora(s) de antecedencia.`});else await (0,i.ZD)({barbershopId:a,appointmentId:e.id,templateType:c,scheduledFor:t,status:"pending"})}else if(o.length>0||c)for(let t of new Set([...o,c].filter(Boolean)))await (0,i.pr)({barbershopId:a,appointmentId:e.id,templateType:t,reason:g?"Agendamento finalizado.":"Lembrete desativado ou sem horario configurado."});if(n&&f){let t=new Date(T.getTime()+864e5);await (0,i.ZD)({barbershopId:a,appointmentId:e.id,templateType:f,scheduledFor:t,status:"pending"})}else if(l.length>0||f)for(let t of new Set([...l,f].filter(Boolean)))await (0,i.pr)({barbershopId:a,appointmentId:e.id,templateType:t,reason:"Pesquisa desativada."})}async function w(e){await (0,i.qK)({appointmentId:e})}async function g(e){if(!e)return;let t=await (0,n.vX)(e);if(!t)return;let a=l(t.messageTemplates),r=new Date(new Date().getTime()-864e5);for(let t of(await (0,o.PD)(e,r)))await f(t,a,e)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972,86,4188],()=>a(65098));module.exports=r})();