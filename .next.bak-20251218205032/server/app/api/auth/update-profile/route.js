"use strict";(()=>{var e={};e.id=9261,e.ids=[9261],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},98067:(e,r,a)=>{a.r(r),a.d(r,{originalPathname:()=>m,patchFetch:()=>w,requestAsyncStorage:()=>c,routeModule:()=>d,serverHooks:()=>f,staticGenerationAsyncStorage:()=>h});var t={};a.r(t),a.d(t,{PATCH:()=>p});var n=a(49303),o=a(88716),i=a(60670),s=a(87070),u=a(75183),l=a(77141);async function p(e){try{let r=(e.headers.get("Authorization")||"").replace("Bearer ","");if(!r)return s.NextResponse.json({error:"Token ausente"},{status:401});let a=(0,u.e)(r);if(!a||"string"==typeof a)return s.NextResponse.json({error:"Token inv\xe1lido"},{status:401});let{email:t,currentPassword:n,newPassword:o,avatarUrl:i,name:p,phone:d}=await e.json();if(!t&&!o&&void 0===i&&void 0===p&&void 0===d)return s.NextResponse.json({error:"Nenhuma altera\xe7\xe3o informada"},{status:400});if(t||o){if(!n)return s.NextResponse.json({error:"Informe a senha atual para continuar"},{status:401});if(!await (0,l.TK)(a.email,n))return s.NextResponse.json({error:"Senha atual inv\xe1lida"},{status:401})}let c=a.email;t&&t!==a.email&&(await (0,l.cJ)(a.userId,t),c=t),o&&await (0,l.Zy)(a.userId,o);let h=a.avatarUrl??null;if(void 0!==i)try{await (0,l.BA)(a.userId,i),h=i??null}catch(r){let e=r?.message||"";if(e.includes("Unknown argument `avatarUrl`")||e.includes("Unknown field"))h=a.avatarUrl??null;else throw r}(void 0!==p||void 0!==d)&&await (0,l.Lj)(a.userId,{name:p??null,phone:d??null});let f={id:a.userId,email:c,name:p??a.name??null,role:a.role,phone:d??a.phone??null,avatarUrl:h},m=(0,u.A)({userId:f.id,email:f.email,role:f.role,name:f.name,phone:f.phone,avatarUrl:f.avatarUrl});return s.NextResponse.json({data:{user:f,accessToken:m}})}catch(e){return console.error("PATCH /api/auth/update-profile error:",e),s.NextResponse.json({error:"Erro ao atualizar perfil"},{status:500})}}let d=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/auth/update-profile/route",pathname:"/api/auth/update-profile",filename:"route",bundlePath:"app/api/auth/update-profile/route"},resolvedPagePath:"/var/www/barberflow/src/app/api/auth/update-profile/route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:c,staticGenerationAsyncStorage:h,serverHooks:f}=d,m="/api/auth/update-profile/route";function w(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:h})}},75183:(e,r,a)=>{a.d(r,{A:()=>s,e:()=>u});var t=a(41482),n=a.n(t);let o=process.env.JWT_SECRET||"super-secret",i=process.env.JWT_EXPIRES_IN||"30m";function s(e){return n().sign(e,o,{expiresIn:i})}function u(e){try{return n().verify(e,o)}catch{return null}}},63841:(e,r,a)=>{a.d(r,{Z:()=>n});var t=a(53524);let n=globalThis.prisma??new t.PrismaClient({log:["error"]})},77141:(e,r,a)=>{a.d(r,{BA:()=>h,Lj:()=>f,TK:()=>s,Zy:()=>c,cI:()=>p,cJ:()=>d,l$:()=>l,r4:()=>i,zI:()=>u});var t=a(98691),n=a(63841);async function o(e){return n.Z.user.findUnique({where:{email:e.toLowerCase()}})}async function i(e){if(await o(e.email))throw Error("E-mail j\xe1 est\xe1 em uso.");let r=await t.ZP.hash(e.password,12);return n.Z.user.create({data:{id:crypto.randomUUID(),email:e.email.toLowerCase(),name:e.name,phone:e.phone,passwordHash:r,role:e.role??"CLIENT",avatarUrl:e.avatarUrl}})}async function s(e,r){let a=await o(e);return a&&a.passwordHash&&await t.ZP.compare(r,a.passwordHash)?a:null}async function u(e,r){await n.Z.user.update({where:{id:e},data:{refreshToken:r}})}async function l(e){await n.Z.user.update({where:{id:e},data:{refreshToken:null}})}async function p(e){return e?n.Z.user.findFirst({where:{refreshToken:e}}):null}async function d(e,r){return n.Z.user.update({where:{id:e},data:{email:r}})}async function c(e,r){let a=await t.ZP.hash(r,12);return n.Z.user.update({where:{id:e},data:{passwordHash:a}})}async function h(e,r){return n.Z.user.update({where:{id:e},data:{avatarUrl:r}})}async function f(e,r){return n.Z.user.update({where:{id:e},data:{name:r.name??void 0,phone:r.phone??void 0}})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var a=e=>r(r.s=e),t=r.X(0,[8948,5972,1482,8691],()=>a(98067));module.exports=t})();