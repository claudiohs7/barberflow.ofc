"use strict";exports.id=4188,exports.ids=[4188],exports.modules={6961:(e,t,a)=>{a.d(t,{pe:()=>n}),new Date().getTime();let n=[{id:"tmpl1",name:"Lembrete Padr\xe3o",type:"Lembrete de Agendamento",content:"Ol\xe1, {cliente}!\nPassando para lembrar do seu hor\xe1rio amanh\xe3 \xe0s {horario} com {barbeiro}.\nAt\xe9 l\xe1!\nEquipe {barbearia}.",enabled:!0,reminderHoursBefore:24},{id:"tmpl2",name:"Confirma\xe7\xe3o Padr\xe3o",type:"Confirma\xe7\xe3o de Agendamento",content:"Ol\xe1, {cliente}!\nSeu agendamento para {servico} no dia {data} \xe0s {horario} foi confirmado.\nEquipe {barbearia}.",enabled:!0},{id:"tmpl4",name:"Confirma\xe7\xe3o Manual",type:"Confirma\xe7\xe3o Manual",content:"Ol\xe1, {cliente}!\nPassando para confirmar seu agendamento para {servico} no dia {data} \xe0s {horario} com {barbeiro}.\nPor favor, responda 'SIM' para confirmar.\nEquipe {barbearia}.",enabled:!0},{id:"tmpl3",name:"Pesquisa Padr\xe3o",type:"Pesquisa de Satisfa\xe7\xe3o",content:"Ol\xe1, {cliente}!\nAgradecemos a sua visita.\nO que voc\xea achou do nosso servi\xe7o?\nResponda de 0 a 10.\nEquipe {barbearia}.",enabled:!1}]},40644:(e,t,a)=>{a.d(t,{cn:()=>s,lV:()=>o,xG:()=>i});var n=a(55761),r=a(62386);function s(...e){return(0,r.m6)((0,n.W)(e))}function i(e){return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(e)}function o(e){return e?e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").replace(/-{2,}/g,"-"):""}},63841:(e,t,a)=>{a.d(t,{Z:()=>r});var n=a(53524);let r=globalThis.prisma??new n.PrismaClient({log:["error"]})},58126:(e,t,a)=>{a.d(t,{PD:()=>o,Pc:()=>l,V2:()=>c,W$:()=>p,ff:()=>d});var n=a(53524),r=a(63841);function s(e){switch(e){case"cancelled":return n.$Enums.AppointmentStatus.CANCELLED;case"completed":return n.$Enums.AppointmentStatus.COMPLETED;case"pending":return n.$Enums.AppointmentStatus.PENDING;default:return n.$Enums.AppointmentStatus.CONFIRMED}}function i(e){return{id:e.id,barbershopId:e.barbershopId,barberId:e.barberId??"",clientId:e.clientId??null,clientName:e.clientName??"",clientPhone:e.clientPhone??"",serviceIds:e.services.map(e=>e.serviceId),startTime:e.startTime,endTime:e.endTime,status:"CANCELLED"===e.status?"cancelled":"COMPLETED"===e.status?"completed":"PENDING"===e.status?"pending":"confirmed",totalDuration:e.totalDuration??void 0}}async function o(e,t,a,n){return(await r.Z.appointment.findMany({where:{barbershopId:e,...n?.clientId?{clientId:n.clientId}:{},...n?.barberId?{barberId:n.barberId}:{},...t||a?{startTime:{gte:t,lte:a}}:{}},orderBy:{startTime:"desc"},include:{services:!0}})).map(i)}async function d(e){return e.length?(await r.Z.appointment.findMany({where:{id:{in:e}},include:{services:!0}})).map(i):[]}async function l(e){let t;return e.clientId&&await r.Z.client.findUnique({where:{id:e.clientId}})&&(t=e.clientId),i(await r.Z.appointment.create({data:{barbershopId:e.barbershopId,barberId:e.barberId??void 0,clientId:t,clientName:e.clientName,clientPhone:e.clientPhone,status:s(e.status),startTime:e.startTime,endTime:e.endTime,totalDuration:e.totalDuration,services:{create:e.serviceIds.map(e=>({serviceId:e}))}},include:{services:!0}}))}async function p(e,t){return i(await r.Z.appointment.update({where:{id:e},data:{barberId:t.barberId??void 0,clientId:t.clientId??void 0,clientName:t.clientName,clientPhone:t.clientPhone,status:t.status?s(t.status):void 0,startTime:t.startTime,endTime:t.endTime,totalDuration:t.totalDuration,...t.serviceIds?{services:{deleteMany:{},create:t.serviceIds.map(e=>({serviceId:e}))}}:{}},include:{services:!0}}))}async function c(e){await r.Z.appointment.delete({where:{id:e}})}},58181:(e,t,a)=>{a.d(t,{JN:()=>f,Pz:()=>b,XX:()=>h,Ye:()=>c,_6:()=>I,kn:()=>m,uq:()=>p,vX:()=>u});var n=a(63841),r=a(40644);function s(e){return e&&e.toLowerCase().includes("prem")?"PREMIUM":"BASIC"}function i(e){return(e||"").replace(/\D/g,"")}function o(e){if(!e)return;if(e instanceof Date)return e;let t=new Date(e);return Number.isNaN(t.getTime())?void 0:t}async function d(e,t){return(await n.Z.barbershop.findMany({where:{cpfCnpj:{not:null},...t?{NOT:{id:t}}:{}},select:{id:!0,cpfCnpj:!0}})).find(t=>i(t.cpfCnpj??"")===e)}function l(e){return{id:e.id,name:e.name,legalName:e.legalName??void 0,cpfCnpj:e.cpfCnpj??void 0,email:e.email??void 0,phone:e.phone??void 0,description:e.description??void 0,ownerId:e.ownerId??void 0,plan:"PREMIUM"===e.plan?"Premium":"B\xe1sico",status:e.status,expiryDate:e.expiryDate?.toISOString(),address:e.addressJson??void 0,operatingHours:e.operatingHoursJson??void 0,logoUrl:e.logoUrl??void 0,whatsappStatus:e.whatsappStatus,qrCodeBase64:e.qrCodeBase64??void 0,bitsafiraInstanceId:e.bitsafiraInstanceId??void 0,bitSafiraToken:e.bitSafiraToken??void 0,whatsAppInstanceId:e.whatsAppInstanceId??void 0,messageTemplates:e.messageTemplates?.map(e=>({id:e.id,name:e.name,content:e.content,enabled:e.enabled,type:e.type,reminderHoursBefore:e.reminderHoursBefore??null}))||[],bitsafiraInstanceData:e.bitsafiraInstanceData??void 0,createdAt:e.createdAt?.toISOString()}}async function p(e){let t=e.id||crypto.randomUUID(),a=i(e.cpfCnpj),r=o(e.expiryDate);if(a&&await d(a))throw Error("CPF/CNPJ j\xe1 est\xe1 cadastrado para outra barbearia.");return l(await n.Z.barbershop.create({data:{id:t,name:e.name,legalName:e.legalName,cpfCnpj:a||e.cpfCnpj,email:e.email,phone:e.phone,description:e.description,ownerId:e.ownerId,plan:s(e.plan),status:e.status,expiryDate:r,addressJson:e.address?e.address:void 0,operatingHoursJson:e.operatingHours?e.operatingHours:void 0,logoUrl:e.logoUrl,whatsappStatus:e.whatsappStatus,qrCodeBase64:e.qrCodeBase64,bitsafiraInstanceId:e.bitsafiraInstanceId??void 0,bitSafiraToken:e.bitSafiraToken??void 0,whatsAppInstanceId:e.whatsAppInstanceId??void 0,bitsafiraInstanceData:e.bitsafiraInstanceData??void 0},include:{messageTemplates:!0}}))}async function c(e,t){let a=i(t.cpfCnpj);if(a&&await d(a,e))throw Error("CPF/CNPJ j\xe1 est\xe1 cadastrado para outra barbearia.");let r=o(t.expiryDate);return l(await n.Z.barbershop.update({where:{id:e},data:{name:t.name,legalName:t.legalName,cpfCnpj:a||t.cpfCnpj,email:t.email,phone:t.phone,description:t.description,ownerId:t.ownerId,plan:t.plan?s(t.plan):void 0,status:t.status,expiryDate:r,addressJson:t.address?t.address:void 0,operatingHoursJson:t.operatingHours?t.operatingHours:void 0,logoUrl:t.logoUrl,whatsappStatus:t.whatsappStatus,qrCodeBase64:t.qrCodeBase64,bitsafiraInstanceId:t.bitsafiraInstanceId,bitSafiraToken:t.bitSafiraToken,whatsAppInstanceId:t.whatsAppInstanceId,bitsafiraInstanceData:t.bitsafiraInstanceData},include:{messageTemplates:!0}}))}async function u(e){let t=await n.Z.barbershop.findUnique({where:{id:e},include:{messageTemplates:!0}});return t?l(t):null}async function m(e){let t=await u(e);if(t)return t;let a=(0,r.lV)(e||"");if(!a)return null;let s=(await n.Z.barbershop.findMany({include:{messageTemplates:!0}})).find(e=>(0,r.lV)(e.name)===a);return s?l(s):null}async function f(e){let t=await n.Z.barbershop.findFirst({where:{bitsafiraInstanceId:e},include:{messageTemplates:!0}});return t?l(t):null}async function b(){return(await n.Z.barbershop.findMany({orderBy:{createdAt:"desc"},include:{messageTemplates:!0}})).map(l)}async function h(e){return(await n.Z.barbershop.findMany({where:{ownerId:e},orderBy:{createdAt:"desc"},include:{messageTemplates:!0}})).map(l)}async function I(e){await n.Z.barbershop.delete({where:{id:e}})}},11803:(e,t,a)=>{a.d(t,{pr:()=>I,Mu:()=>f,ip:()=>b,qK:()=>w,Yt:()=>y,Yu:()=>h,ZD:()=>m});var n=a(63841);let r=[];function s(e){let t=new Date,a=r.findIndex(t=>t.appointmentId===e.appointmentId&&t.templateType===e.templateType);if(a>=0){let n=r[a];return"sent"===n.status?n:(r[a]={...n,scheduledFor:e.scheduledFor,status:e.status??n.status,attempts:e.attempts??n.attempts,lastError:void 0===e.lastError?n.lastError:e.lastError,sentAt:e.sentAt??n.sentAt??null,updatedAt:t},r[a])}let n={id:e.id||`${Date.now()}-${Math.random().toString(36).slice(2)}`,barbershopId:e.barbershopId,appointmentId:e.appointmentId,templateType:e.templateType,scheduledFor:e.scheduledFor,status:e.status??"pending",attempts:e.attempts??0,lastError:void 0===e.lastError?null:e.lastError,sentAt:e.sentAt??null,createdAt:t,updatedAt:t};return r.unshift(n),n}function i(e,t){return r.filter(a=>a.barbershopId===e&&"pending"===a.status&&a.scheduledFor.getTime()<=t.getTime()).sort((e,t)=>e.scheduledFor.getTime()-t.scheduledFor.getTime())}function o(e,t){return r.filter(a=>a.barbershopId===e&&(!t||a.status===t)).sort((e,t)=>e.scheduledFor.getTime()-t.scheduledFor.getTime())}function d(e,t){let a=r.findIndex(t=>t.id===e);if(a<0)return;let n=r[a];r[a]={...n,status:t.status??n.status,attempts:t.attempts??n.attempts,lastError:void 0===t.lastError?n.lastError:t.lastError,sentAt:void 0===t.sentAt?n.sentAt:t.sentAt,updatedAt:new Date}}function l(e,t,a){let n=new Date;for(let s of r)s.appointmentId===e&&s.templateType===t&&(s.status="cancelled",s.lastError=a||s.lastError,s.updatedAt=n)}function p(e,t){for(let a=r.length-1;a>=0;a-=1){let n=r[a];n.appointmentId!==e||t&&n.templateType!==t||r.splice(a,1)}}function c(e){let t=r.findIndex(t=>t.id===e);t>=0&&r.splice(t,1)}function u(){return n.Z.whatsappmessagequeue}async function m(e){let t=u();if(!t){console.warn("Modelo whatsappmessagequeue nao encontrado. Usando fila em memoria."),s({...e,status:e.status??"pending",attempts:0,lastError:null,sentAt:null});return}try{let a=await t.findUnique({where:{appointmentId_templateType:{appointmentId:e.appointmentId,templateType:e.templateType}}});if(a?.status==="sent")return;if(a){await t.update({where:{id:a.id},data:{scheduledFor:e.scheduledFor,status:e.status??a.status,attempts:a.attempts,lastError:a.lastError,sentAt:a.sentAt}});return}await t.create({data:{barbershopId:e.barbershopId,appointmentId:e.appointmentId,templateType:e.templateType,scheduledFor:e.scheduledFor,status:e.status??"pending",attempts:0}})}catch(t){console.warn("Falha ao gravar fila no banco. Usando fila em memoria.",t),s({...e,status:e.status??"pending",attempts:0,lastError:null,sentAt:null})}}async function f(e,t){let a=u();if(!a)return i(e,t);try{return await a.findMany({where:{barbershopId:e,status:"pending",scheduledFor:{lte:t}},orderBy:{scheduledFor:"asc"}})}catch(a){return console.warn("Falha ao ler fila no banco. Usando fila em memoria.",a),i(e,t)}}async function b(e,t){let a=u();if(!a)return o(e,t);try{return await a.findMany({where:{barbershopId:e,...t?{status:t}:{}},orderBy:{scheduledFor:"asc"}})}catch(a){return console.warn("Falha ao ler fila no banco. Usando fila em memoria.",a),o(e,t)}}async function h(e){let t=u();if(!t){d(e.id,{status:e.status,attempts:e.attempts,lastError:e.lastError,sentAt:e.sentAt});return}try{await t.update({where:{id:e.id},data:{status:e.status,attempts:e.attempts,lastError:e.lastError??null,sentAt:e.sentAt??null}})}catch(t){console.warn("Falha ao atualizar fila no banco. Usando fila em memoria.",t),d(e.id,{status:e.status,attempts:e.attempts,lastError:e.lastError,sentAt:e.sentAt})}}async function I(e){let t=u();if(!t){l(e.appointmentId,e.templateType,e.reason);return}try{await t.updateMany({where:{barbershopId:e.barbershopId,appointmentId:e.appointmentId,templateType:e.templateType},data:{status:"cancelled",lastError:e.reason??null}})}catch(t){console.warn("Falha ao cancelar fila no banco. Usando fila em memoria.",t),l(e.appointmentId,e.templateType,e.reason)}}async function w(e){let t=u();if(!t){p(e.appointmentId,e.templateType);return}try{await t.deleteMany({where:{appointmentId:e.appointmentId,...e.templateType?{templateType:e.templateType}:{}}})}catch(t){console.warn("Falha ao remover fila no banco. Usando fila em memoria.",t),p(e.appointmentId,e.templateType)}}async function y(e){let t=u();if(!t){c(e);return}try{await t.delete({where:{id:e}})}catch(t){console.warn("Falha ao remover item da fila no banco. Usando fila em memoria.",t),c(e)}}},1624:(e,t,a)=>{a.d(t,{M8:()=>s,bY:()=>r,dU:()=>i,s0:()=>n});let n=e=>(e||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();function r(e,t){let a=n(t);return n(e.type).includes(a)||n(e.name).includes(a)}function s(e,t){let a=n(t);return n(e.type).includes(a)?e.type:n(e.name).includes(a)?e.name:e.type||e.name}function i(e,t){let a=new Map;for(let t of e){let e=n(t.type);e&&a.set(e,t)}for(let e of t){let t=n(e.type);t&&a.set(t,e)}return Array.from(a.values())}}};