"use strict";exports.id=8207,exports.ids=[8207],exports.modules={21762:(e,t,a)=>{a.d(t,{q:()=>i});class n{constructor(e){this.token=e.token,this.baseUrl=e.baseUrl||"https://api.bitsafira.com.br"}async request(e,t,a){let n={method:e,headers:{"Content-Type":"application/json",Token:this.token},redirect:"follow"};a&&(n.body=JSON.stringify(a));try{let e=await fetch(`${this.baseUrl}${t}`,n),a=await e.json();return{status:e.status,message:a.message||a.mensagem,mensagem:a.mensagem,error:a.error,dados:a.dados||a}}catch(a){return console.error(`BitSafira API Error [${e} ${t}]:`,a),{status:500,message:"Erro de comunica\xe7\xe3o com a API BitSafira.",error:a.message}}}async authenticate(e){return this.request("POST","/auth",e)}async listInstances(){return this.request("GET","/instancias")}async getInstanceInfo(e){return this.request("GET",`/instancia/info?id=${encodeURIComponent(e)}`)}async createInstance(e){return this.request("POST","/instancia/salvar",e)}async deleteInstance(e){return this.request("DELETE","/instancia/deletar",e)}async connectInstance(e){return this.request("POST","/instancia/conectar",e)}async disconnectInstance(e){return this.request("POST","/instancia/desconectar",e)}async sendMessage(e){let t=await this.request("POST","/disparo/enviar",e);if(404!==t.status)return t;let a=await this.request("POST","/mensagem/disparar",e);return 404!==a.status?a:this.request("POST","/mensagem/enviar",e)}async verifyNumber(e){return this.request("POST","/numero/verificar",e)}}function i(e){let t=e||process.env.BITSAFIRA_TOKEN,a=process.env.BITSAFIRA_BASE_URL;if(!t)throw Error("BITSAFIRA_TOKEN is not defined in environment variables or provided.");return new n({token:t,baseUrl:a})}},8778:(e,t,a)=>{a.d(t,{Sj:()=>s,_S:()=>o,qn:()=>c,xU:()=>d});var n=a(63841),i=a(84770);function r(e){return{id:e.id,name:e.name,phone:e.phone??"",email:e.email??void 0,userId:e.userId??void 0,avatarUrl:e.avatarUrl??"",schedule:e.scheduleJson??[],services:e.services?.map(e=>({serviceId:e.serviceId,duration:e.durationMinutes??void 0}))??[]}}async function s(e){return(await n.Z.barber.findMany({where:{barbershopId:e},orderBy:{name:"asc"},include:{services:!0}})).map(r)}async function o(e){return r(await n.Z.barber.create({data:{id:(0,i.randomUUID)(),barbershopId:e.barbershopId,userId:e.userId??void 0,name:e.name,phone:e.phone,email:e.email,avatarUrl:e.avatarUrl,scheduleJson:e.schedule??[],services:{create:e.services?.map(e=>({serviceId:e.serviceId,durationMinutes:e.duration}))}},include:{services:!0}}))}async function c(e,t){return r(await n.Z.barber.update({where:{id:e},data:{name:t.name,phone:t.phone,email:t.email,avatarUrl:t.avatarUrl,scheduleJson:t.schedule??void 0,...t.services?{services:{deleteMany:{},create:t.services.map(e=>({serviceId:e.serviceId,durationMinutes:e.duration}))}}:{}},include:{services:!0}}))}async function d(e){await n.Z.barber.delete({where:{id:e}})}},18265:(e,t,a)=>{a.d(t,{G6:()=>c,Pg:()=>d,o3:()=>o,wo:()=>l});var n=a(53524),i=a(84770),r=a(63841);function s(e){return{id:e.id,barbershopId:e.barbershopId,name:e.name,description:e.description??void 0,duration:e.durationMinutes,price:Number(e.price),active:e.active}}async function o(e){return(await r.Z.service.findMany({where:{barbershopId:e},orderBy:{name:"asc"}})).map(s)}async function c(e,t){return s(await r.Z.service.create({data:{id:(0,i.randomUUID)(),barbershopId:e,name:t.name,description:t.description,durationMinutes:t.duration,price:new n.Prisma.Decimal(t.price),active:t.active??!0}}))}async function d(e,t){return s(await r.Z.service.update({where:{id:e},data:{name:t.name,description:t.description,durationMinutes:t.duration,price:void 0!==t.price?new n.Prisma.Decimal(t.price):void 0,active:t.active}}))}async function l(e){await r.Z.service.delete({where:{id:e}})}},26003:(e,t,a)=>{a.d(t,{C:()=>s,U:()=>o});var n=a(63841);let i=[];function r(e){return e?i.filter(t=>t.barbershopId===e):i}async function s(e){if(!e.length)return;let t=()=>{var t;t=e.map(e=>({id:e.id||`${Date.now()}-${Math.random().toString(36).slice(2)}`,barbershopId:e.barbershopId,appointmentId:e.appointmentId??null,clientName:e.clientName??void 0,clientPhone:e.clientPhone??void 0,templateType:e.templateType??void 0,status:e.status,message:e.message,sentAt:(e.sentAt?new Date(e.sentAt):new Date).toISOString(),details:e.details??void 0})),i.unshift(...t),i.length>200&&(i.length=200)},a=n.Z.whatsappmessagelog;if(!a){console.warn("Modelo whatsappmessagelog nao encontrado. Usando log em memoria."),t();return}let r=e.map(e=>({...e.id?{id:e.id}:{},barbershopId:e.barbershopId,appointmentId:e.appointmentId??null,clientName:e.clientName??null,clientPhone:e.clientPhone??null,templateType:e.templateType??null,status:e.status,message:e.message,sentAt:e.sentAt?new Date(e.sentAt):new Date,details:e.details??null}));try{await a.createMany({data:r})}catch(e){console.warn("Falha ao gravar logs no banco. Usando log em memoria.",e),t()}}async function o(e){let t=n.Z.whatsappmessagelog;if(!t)return r(e);try{return t.findMany({where:e?{barbershopId:e}:void 0,orderBy:{sentAt:"desc"}})}catch(t){return console.warn("Falha ao ler logs do banco. Usando log em memoria.",t),r(e)}}},78207:(e,t,a)=>{a.d(t,{h:()=>g});var n=a(58181),i=a(58126),r=a(8778),s=a(18265),o=a(21762),c=a(6961),d=a(40644),l=a(26003),m=a(11803),p=a(1624);let u=e=>{let t=(0,p.s0)(e);return t.includes("lembrete")?"Lembrete":t.includes("pesquisa")?"Pesquisa":"Mensagem"};async function h(e,t){let a=e.bitSafiraToken||process.env.BITSAFIRA_TOKEN,n=e.bitsafiraInstanceId||process.env.BITSAFIRA_INSTANCE_ID;if(!a||!n)throw Error("Token ou ID da instancia BitSafira nao configurados.");let i=(0,o.q)(a),r=t.number.replace(/\D/g,""),s=r.startsWith("55")?r:`55${r}`,c=await i.sendMessage({idInstancia:n,whatsapp:s,texto:t.message,envioImediato:1});if(![200,201].includes(c.status))throw Error(c.mensagem||c.message||"Falha ao enviar mensagem.")}async function g(e){if(!e)throw Error("Barbearia nao encontrada");let t=await (0,n.vX)(e);if(!t)throw Error("Barbearia nao encontrada");let a=(0,p.dU)(c.pe,t?.messageTemplates??[]),o=new Date,g=await (0,m.Mu)(e,o);if(!g.length)return{message:"Nenhuma mensagem pendente para envio.",processed:0,skipped:0,results:[]};let v=Array.from(new Set(g.map(e=>e.appointmentId))).filter(e=>!!e),[w,f,b]=await Promise.all([(0,i.ff)(v),(0,r.Sj)(e),(0,s.o3)(e)]),I=new Map(w.map(e=>[e.id,e])),y=new Map(f.map(e=>[e.id,e.name])),S=new Map(b.map(e=>[e.id,{name:e.name,price:e.price}])),T=[],A=[];for(let n of g){let i=function(e,t){let a=e.filter(e=>e.enabled),n=a.find(e=>e.type===t||e.name===t);if(n)return n;let i=(0,p.s0)(t);return a.find(e=>(0,p.s0)(e.type)===i||(0,p.s0)(e.name)===i)||(i.includes("pesquisa")?a.find(e=>(0,p.bY)(e,"pesquisa"))||null:i.includes("lembrete")?a.find(e=>(0,p.bY)(e,"lembrete"))||null:i.includes("confirmacao")&&a.find(e=>(0,p.bY)(e,"confirmacao"))||null)}(a,n.templateType||""),r=u(n.templateType||"");if(!i){await (0,m.Yu)({id:n.id,status:"cancelled",lastError:"Template desativado ou nao encontrado."}),A.push({id:`${Date.now()}-${Math.random().toString(36).slice(2)}`,barbershopId:e,appointmentId:n.appointmentId,clientName:void 0,clientPhone:void 0,templateType:n.templateType,status:"skipped",message:`${r} ignorado: template desativado ou nao encontrado.`,sentAt:new Date().toISOString()});continue}let s=(0,p.s0)(n.templateType||i.type||""),c=s.includes("lembrete"),l=s.includes("pesquisa"),g=I.get(n.appointmentId);if(!g){await (0,m.Yu)({id:n.id,status:"cancelled",lastError:"Agendamento nao encontrado."}),A.push({id:`${Date.now()}-${Math.random().toString(36).slice(2)}`,barbershopId:e,appointmentId:n.appointmentId,clientName:void 0,clientPhone:void 0,templateType:n.templateType,status:"skipped",message:`${r} ignorado: agendamento nao encontrado.`,sentAt:new Date().toISOString()});continue}if("cancelled"===g.status){await (0,m.Yu)({id:n.id,status:"cancelled",lastError:"Agendamento cancelado."}),A.push({id:`${Date.now()}-${Math.random().toString(36).slice(2)}`,barbershopId:e,appointmentId:g.id,clientName:g.clientName,clientPhone:g.clientPhone,templateType:n.templateType,status:"skipped",message:`${r} ignorado: agendamento cancelado.`,sentAt:new Date().toISOString()});continue}if("completed"===g.status&&!l){await (0,m.Yu)({id:n.id,status:"cancelled",lastError:"Agendamento finalizado."}),A.push({id:`${Date.now()}-${Math.random().toString(36).slice(2)}`,barbershopId:e,appointmentId:g.id,clientName:g.clientName,clientPhone:g.clientPhone,templateType:n.templateType,status:"skipped",message:`${r} ignorado: agendamento finalizado.`,sentAt:new Date().toISOString()});continue}if(!g.clientPhone){await (0,m.Yu)({id:n.id,status:"error",lastError:"Cliente sem numero de WhatsApp."}),A.push({id:`${Date.now()}-${Math.random().toString(36).slice(2)}`,barbershopId:e,appointmentId:g.id,clientName:g.clientName,clientPhone:g.clientPhone,templateType:n.templateType,status:"error",message:"Falha ao enviar mensagem: cliente sem numero de WhatsApp.",sentAt:new Date().toISOString()});continue}let v=new Date(g.startTime);if(c&&n.createdAt){let t=new Date(n.createdAt),a=n.scheduledFor?new Date(n.scheduledFor):null;if(a&&t.getTime()>a.getTime()){await (0,m.Yu)({id:n.id,status:"cancelled",lastError:"Agendamento criado/alterado apos o horario do lembrete."}),A.push({id:`${Date.now()}-${Math.random().toString(36).slice(2)}`,barbershopId:e,appointmentId:g.id,clientName:g.clientName,clientPhone:g.clientPhone,templateType:n.templateType,status:"skipped",message:`${r} ignorado: agendamento criado/alterado com pouca antecedencia.`,sentAt:new Date().toISOString()});continue}}if(c&&v<=o){await (0,m.Yu)({id:n.id,status:"cancelled",lastError:"Horario do agendamento ja comecou."}),A.push({id:`${Date.now()}-${Math.random().toString(36).slice(2)}`,barbershopId:e,appointmentId:g.id,clientName:g.clientName,clientPhone:g.clientPhone,templateType:n.templateType,status:"skipped",message:`${r} ignorado: horario ja comecou/terminou.`,sentAt:new Date().toISOString()});continue}let w=g.serviceIds.map(e=>S.get(e)).filter(Boolean),f=w.map(e=>e.name).join(", "),b=w.reduce((e,t)=>e+Number(t.price||0),0),P=function(e,t){let a=e.content;return(a=(a=(a=(a=(a=(a=(a=a.replace("{cliente}",t.clientName)).replace("{servico}",t.services||"")).replace("{valor}",t.serviceValue||"")).replace("{data}",t.startTime.toLocaleDateString())).replace("{horario}",t.startTime.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}))).replace("{barbeiro}",t.barberName||"")).replace("{barbearia}",t.barbershopName||"sua barbearia")).replace("{endereco}",t.barbershopAddress||"")}(i,{clientName:g.clientName,barbershopName:t.name||"sua barbearia",services:f,serviceValue:(0,d.xG)(b),barbershopAddress:function(e){let t=e?.address;if(!t)return"";let a=t.street?.trim(),n=t.number?.trim(),i=t.complement?.trim(),r=t.neighborhood?.trim(),s=t.city?.trim(),o=t.state?.trim();return[[a,n].filter(Boolean).join(", ")+(i?` ${i}`:""),[r,s,o].filter(Boolean).join(" - ")].filter(Boolean).join(" - ")}(t),startTime:v,barberName:y.get(g.barberId)||"Barbeiro"}),D=(n.attempts??0)+1;try{await h(t,{number:g.clientPhone,message:P}),await (0,m.Yu)({id:n.id,status:"sent",attempts:D,lastError:null,sentAt:new Date}),T.push({appointmentId:g.id,success:!0}),A.push({id:`${Date.now()}-${Math.random().toString(36).slice(2)}`,barbershopId:e,appointmentId:g.id,clientName:g.clientName,clientPhone:g.clientPhone,templateType:n.templateType,status:"success",message:P,sentAt:new Date().toISOString(),details:`Mensagem enviada. Agendado para: ${n.scheduledFor?.toISOString?.()||""}`})}catch(t){await (0,m.Yu)({id:n.id,status:"error",attempts:D,lastError:t?.message||"Falha ao enviar mensagem."}),T.push({appointmentId:g.id,success:!1,message:t?.message||"Falha ao enviar mensagem."}),A.push({id:`${Date.now()}-${Math.random().toString(36).slice(2)}`,barbershopId:e,appointmentId:g.id,clientName:g.clientName,clientPhone:g.clientPhone,templateType:n.templateType,status:"error",message:t?.message||"Falha ao enviar mensagem.",sentAt:new Date().toISOString()})}}if(A.length>0)try{await (0,l.C)(A)}catch(e){console.warn("Falha ao registrar logs de lembrete:",e)}return{message:"Processo de mensagens concluido.",processed:T.length,skipped:A.filter(e=>"skipped"===e.status).length,results:T}}}};